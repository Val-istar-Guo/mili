#!/usr/bin/env node
const program = require('commander')
const log = require('../src/log')
const init = require('./init')
const upgrade = require('./upgrade')
const update = require('./update')
const clean = require('./clean')
const { version } = require('../package.json')


program
  .version(version)

program
  .command('init [repository]')
  .usage('[options] <repository>')
  .description('initialize the project')
  .option('-n --app-name [app_name]', `Set your app name.`)
  .option('--force')
  .action((repository, option) => {
    if (!repository) program.help()

    const { appName, force = false } = option

    log.info('initialize project ...')

    return init(appName, repository, force)
      .then(() => log.info('initialize complete'))
      .catch(err => log.error('program', 'initialize break', err))
  })

program
  .command('upgrade')
  .description('upgrade the template')
  .option('--force')
  .action((option) => {
    const { force = false } = option

    log.info('prepare upgrade')
    upgrade(force)
      .then(() => log.info('upgrade complete'))
      .catch(err => log.error('program', 'upgrade break', err))
  })

program
  .command('update')
  .description('Update the project with the current version of the template')
  .option('--force')
  .action((option) => {
    const { force = false } = option

    log.info('prepare update')
    update(force)
      .then(() => log.info('update complete'))
      .catch(err => log.error('program', 'update break', err))
  })

program
  .command('clean')
  .description('Clean the cache of mili')
  .action(() => {
    log.info('begin clean')
    clean()
      .then(() => log.info('clean complete'))
      .catch(err => log.error('clean', 'clean break', err))
  })


// error on unknown commands
program.on('command:*', function () {
  log.error('command', 'Invalid command: %s\nSee --help for a list of available commands.', program.args.join(' '));
  process.exit(1);
});


program.parse(process.argv)

if (!process.argv.slice(2).length) program.help();
