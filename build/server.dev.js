const fs = require('fs');
const vm = require('vm');
const path = require('path');
const chalk = require('chalk');
const Module = require('module');
const webpack = require('webpack');
const MemoryFileSystem = require('memory-fs');
const requireFromString = require('require-from-string');
require('source-map-support').install();


// Babel require hook
const babelConfig = JSON.parse(fs.readFileSync(
  path.resolve(__dirname, '../.babelrc'),
  'utf8'));
babelConfig.plugins.push('add-module-exports');

require('babel-register')(babelConfig);
const {
  setBundle,
  setManifest,
  createServer,
  readFile } = require('./helper');

// init compiler
const { ssrFileName, manifestFileName } = require('./webpack.config.expand');


/**
 * NOTE devConfig used to make template
 *      and make webpack dev middleware
 */
const devConfig = require('./webpack.config.client.dev');
const devCompiler = webpack(devConfig);

/**
 * NOTE Webpack hook event to write html file template
 *      due to server render
 */
devCompiler.plugin('done', stats => {
  const info = stats.toJson();

  info.errors.forEach(err => console.log(chalk.red.bold(err)));
  info.warnings.forEach(warn => console.log(chalk.yellow(warn)));
  if (info.errors.length) return;

  manifest = JSON.parse(readFile(
    devCompiler.outputFileSystem,
    path.resolve(devConfig.output.path, manifestFileName),
  ));

  setManifest(manifest);
});


/**
 * NOTE ssrConfig used to make vue ssr bundle json file.
 *      It is must after devConfig because replay file template
 */
const ssrConfig = require('./webpack.config.ssr');
const ssrCompiler = webpack(ssrConfig);

const ssrMfs = new MemoryFileSystem();
ssrCompiler.outputFileSystem = ssrMfs;

// NOTE read bundle generated by vue-ssr-webpack-plugin
ssrCompiler.watch({}, (err, stats) => {
  if (err) throw err;

  const info = stats.toJson();

  info.errors.forEach(err => console.log(chalk.red.bold(err)));
  info.warnings.forEach(warn => console.log(chalk.yellow(warn)));
  if (info.errors.length) return;


  bundle = JSON.parse(readFile(
    ssrMfs,
    path.join(ssrConfig.output.path, ssrFileName),
  ));

  setBundle(bundle);
});

const serverConfig = require('./webpack.config.server.dev');
const serverCompiler = webpack(serverConfig);

const serverMfs = new MemoryFileSystem();
serverCompiler.outputFileSystem = serverMfs;


/**
 * if koa(inclode it's middleware) coudle be closed
 * serverCompiler can use watch module,
 * and will not rely on pm2 in the development environment
 */
serverCompiler.run((err, stats) => {
  if (err) throw err;

  const info = stats.toJson();
  const chunkName = info.assetsByChunkName.bundle;

  info.errors.forEach(err => console.log(chalk.red.bold(err)));
  info.warnings.forEach(warn => console.log(chalk.yellow(warn)));
  if (info.errors.length) return;

  const code = readFile(
    serverMfs,
    path.resolve(serverConfig.output.path, chunkName),
  );

  const server = requireFromString(code, chunkName).default;
  console.log(chalk.green('🍻  Server-side code is compiled'));

  createServer(server, devCompiler);
});

console.log(chalk.green('⌛️  Wait for the server-side code to compile...'));
